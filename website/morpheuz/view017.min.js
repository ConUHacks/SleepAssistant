function mConst(){var a={awakeAbove:1000,lightAbove:120,sampleIntervalMins:10};return a}function hrsmin(c){var a=Math.floor(c/60);var b=c%60;return fixLen(String(a))+":"+fixLen(String(b))}Date.prototype.format=function(b){var c={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"i+":this.getHours()+1,"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};if(/(y+)/.test(b)){b=b.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))}for(var a in c){if(new RegExp("("+a+")").test(b)){b=b.replace(RegExp.$1,RegExp.$1.length==1?c[a]:("00"+c[a]).substr((""+c[a]).length))}}return b};Date.prototype.addMinutes=function(b){var a=new Date(this.getTime());return new Date(a.getTime()+b*60000)};function setSelectedValue(c,a){c.style.display="inline";for(var b=0;b<c.options.length;b++){if(c.options[b].text==a){c.options[b].selected=true;return}}}function setTextValue(b,a){b.style.display="inline";b.value=fixLen(a)}function getSelectedValue(a){return a.options[a.selectedIndex].value}function getTextValue(c,a){var b=parseInt(c.value,10);if(isNaN(b)||(a&&(b<0||b>23))||(!a&&(b<0||b>59))){c.style.backgroundColor="red";return"X"}return fixLen(String(b))}function fixLen(a){if(a==null||a.length>1){return a}return"0"+a}function getParameterByName(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var c=new RegExp("[\\?&]"+a+"=([^&#]*)"),b=c.exec(location.search);return b==null?"":decodeURIComponent(b[1].replace(/\+/g," "))}document.ios=navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i);var baseStr=getParameterByName("base");var base=new Date().valueOf();if(baseStr!=""&&baseStr!="null"){base=parseInt(baseStr,10)}var graph=getParameterByName("graph");var fromhr=getParameterByName("fromhr");var frommin=getParameterByName("frommin");var tohr=getParameterByName("tohr");var tomin=getParameterByName("tomin");var smart=getParameterByName("smart");var inverse=getParameterByName("inverse");var vers=getParameterByName("vers");var goneoff=getParameterByName("goneoff");var smartOn=smart=="Y";var inverseOn=inverse=="Y";document.getElementById("smartalarm").checked=smartOn;document.getElementById("inverse").checked=inverseOn;if(document.ios){document.getElementById("reset").className="reset";document.getElementById("mail").className="copy";setSelectedValue(document.getElementById("safromhour"),fromhr);setSelectedValue(document.getElementById("safrommin"),frommin);setSelectedValue(document.getElementById("satohour"),tohr);setSelectedValue(document.getElementById("satomin"),tomin)}else{setTextValue(document.getElementById("safromhourtxt"),fromhr);setTextValue(document.getElementById("safrommintxt"),frommin);setTextValue(document.getElementById("satohourtxt"),tohr);setTextValue(document.getElementById("satomintxt"),tomin)}document.getElementById("version").textContent=vers;var startPoint=new Date(base);var splitup=graph.split("!");var more=new Array();for(var i=0;i<splitup.length;i++){if(splitup[i]==""){continue}var element=new Array();element[0]=startPoint;element[1]=parseInt(splitup[i],10);if(element[1]==-1){element[1]=null}more[i]=element;startPoint=startPoint.addMinutes(mConst().sampleIntervalMins)}var canvasOverlayConf;if(smartOn){var fromstr=fixLen(fromhr)+fixLen(frommin);var tostr=fixLen(tohr)+fixLen(tomin);var smartStartPoint=new Date(base);var early=null;var late=null;var actual=null;for(var i=0;i<splitup.length;i++){var teststr1=smartStartPoint.format("hhmm");var smartStartPoint1=smartStartPoint;smartStartPoint=smartStartPoint.addMinutes(mConst().sampleIntervalMins);var teststr2=smartStartPoint.format("hhmm");if(early==null&&fromstr>=teststr1&&fromstr<=teststr2){early=smartStartPoint1}if(late==null&&tostr>=teststr1&&tostr<=teststr2){late=smartStartPoint1}if(actual==null&&goneoff!="N"&&goneoff>=teststr1&&goneoff<=teststr2){actual=smartStartPoint1}if(late!=null&&early!=null&&actual!=null){break}}if(early!=null&&late!=null){var canvasOverlayActual;if(actual!=null){canvasOverlayActual={verticalLine:{name:"actual",x:actual,lineWidth:1,yOffset:0,color:"rgb(255, 149, 0)",shadow:false}}}canvasOverlayConf={show:true,objects:[{dashedVerticalLine:{name:"start",x:early,lineWidth:1,yOffset:0,dashPattern:[1,4],color:"rgb(76, 217, 100)",shadow:false}},{dashedVerticalLine:{name:"end",x:late,lineWidth:1,yOffset:0,dashPattern:[1,4],color:"rgb(255, 59, 48)",shadow:false}},canvasOverlayActual]}}}var pieStartPoint=new Date(base);var points=0;var total=0;var awake=0;var deep=0;var light=0;for(var i=0;i<splitup.length;i++){if(splitup[i]==""){continue}var data=parseInt(splitup[i],10);var teststr1=pieStartPoint.format("hhmm");var pieStartPoint1=pieStartPoint;pieStartPoint=pieStartPoint.addMinutes(mConst().sampleIntervalMins);var teststr2=pieStartPoint.format("hhmm");if(goneoff!="N"&&goneoff>=teststr1&&goneoff<=teststr2){break}if(data==-1){continue}if(data>mConst().awakeAbove){awake++}else{if(data>mConst().lightAbove){light++}else{deep++}}}document.getElementById("ttotal").textContent=hrsmin((deep+light+awake)*mConst().sampleIntervalMins);document.getElementById("tawake").textContent=hrsmin(awake*mConst().sampleIntervalMins);document.getElementById("tlight").textContent=hrsmin(light*mConst().sampleIntervalMins);document.getElementById("tdeep").textContent=hrsmin(deep*mConst().sampleIntervalMins);var data2=[["Awake?",awake],["Light",light],["Deep",deep]];$(document).ready(function(){var b=$.jqplot("chart1",[more],{grid:{background:"#ffffff"},animate:true,canvasOverlay:canvasOverlayConf,series:[{showMarker:false,breakOnNull:true,color:"rgb(0,122,255)",label:new Date(base).format("yyyy-MM-dd"),trendline:{show:true,color:"rgb(90,200,250)",label:"",type:"linear",shadow:true,lineWidth:1.5,shadowAngle:45,shadowOffset:1.5,shadowDepth:3,shadowAlpha:0.07}}],axesDefaults:{labelRenderer:$.jqplot.CanvasAxisLabelRenderer,showTicks:false,showTickMarks:false},legend:{show:true,location:"ne"},axes:{xaxis:{renderer:$.jqplot.DateAxisRenderer,tickRenderer:$.jqplot.CanvasAxisTickRenderer,tickOptions:{formatString:"%R",angle:-30,fontSize:"8pt"},tickInterval:"1 hour",pad:0,showTicks:true,showTickMarks:true,min:new Date(base)},yaxis:{label:"Movement",min:-50,max:4000}}});var a=jQuery.jqplot("chart2",[data2],{grid:{background:"#ffffff"},seriesColors:["rgb(90, 200, 250)","rgb(0,122,255)","rgb(88,86,214)"],seriesDefaults:{renderer:jQuery.jqplot.PieRenderer,rendererOptions:{showDataLabels:true}},legend:{show:true,location:"e"}})});var timePoint=new Date(base);var body="&body=";var copyBody="";for(var i=0;i<splitup.length;i++){if(splitup[i]==""){continue}body=body+timePoint.format("hh:mm")+","+splitup[i]+"%0D%0A";copyBody=copyBody+timePoint.format("hh:mm")+","+splitup[i]+"\r\n";timePoint=timePoint.addMinutes(mConst().sampleIntervalMins)}var mailto="mailto:?subject=Morpheuz-"+new Date(base).format("yyyy-MM-dd")+".csv"+body;document.getElementById("mail").href=mailto;document.getElementById("copy").value=copyBody;$("#copy").focus(function(){var a=$(this);a.select();a.mouseup(function(){a.unbind("mouseup");return false})});document.getElementById("reset").onclick=function(){var a=document.getElementById("smartalarm").checked?"Y":"N";var c=document.getElementById("inverse").checked?"Y":"N";var f="";var b="";var d="";var e="";if(document.ios){f=getSelectedValue(document.getElementById("safromhour"));b=getSelectedValue(document.getElementById("safrommin"));d=getSelectedValue(document.getElementById("satohour"));e=getSelectedValue(document.getElementById("satomin"))}else{f=getTextValue(document.getElementById("safromhourtxt"),true);b=getTextValue(document.getElementById("safrommintxt"),false);d=getTextValue(document.getElementById("satohourtxt"),true);e=getTextValue(document.getElementById("satomintxt"),false);if(f=="X"||b=="X"||d=="X"||e=="X"){return}}if((f+":"+b)>=(d+":"+e)){document.getElementById("safromhour").style.backgroundColor="red";document.getElementById("safrommin").style.backgroundColor="red";document.getElementById("satohour").style.backgroundColor="red";document.getElementById("satomin").style.backgroundColor="red";document.getElementById("safromhourtxt").style.backgroundColor="red";document.getElementById("safrommintxt").style.backgroundColor="red";document.getElementById("satohourtxt").style.backgroundColor="red";document.getElementById("satomintxt").style.backgroundColor="red"}else{window.location.href="pebblejs://close#reset!"+a+"!"+f+"!"+b+"!"+d+"!"+e+"!"+c}};